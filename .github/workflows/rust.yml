name: Rust

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  determine:
    runs-on: ubuntu-latest
    outputs:
      stable: ${{ steps.determine.outputs.stable }}
      build_needed: ${{ steps.determine.outputs.build_needed }}
      docker_needed: ${{ steps.determine.outputs.docker_needed }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends jq
          sudo rm -rf /var/lib/apt/lists/*

      - name: Determine flags and changed paths
        id: determine
        shell: bash
        run: |
          set -euo pipefail

          # Read event data from the event JSON to avoid any shell interpolation of commit messages.
          EVENT_NAME="${GITHUB_EVENT_NAME}"
          MSG=""
          if [ -f "${GITHUB_EVENT_PATH}" ]; then
            MSG="$(jq -r '.head_commit.message // ""' "${GITHUB_EVENT_PATH}" 2>/dev/null || true)"
          fi

          STABLE=false
          if [ "${EVENT_NAME}" = "push" ] && printf '%s' "${MSG}" | grep -Fq '[stable]'; then
            STABLE=true
          fi
          printf 'stable=%s\n' "${STABLE}" >> "${GITHUB_OUTPUT}"

          BASE_SHA=""
          if [ -f "${GITHUB_EVENT_PATH}" ]; then
            # push: .before, pull_request: .pull_request.base.sha
            BASE_SHA="$(jq -r 'if .pull_request then .pull_request.base.sha else .before end // ""' "${GITHUB_EVENT_PATH}" 2>/dev/null || true)"
          fi
          if [ -z "${BASE_SHA}" ] || [ "${BASE_SHA}" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="$(git rev-parse HEAD^ 2>/dev/null || true)"
          fi
          HEAD_SHA="${GITHUB_SHA}"

          CHANGED_FILES=""
          if [ -n "${BASE_SHA}" ]; then
            CHANGED_FILES="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" || true)"
          fi

          # Decide whether to build/test and whether to publish docker based on changed files.
          if printf '%s\n' "${CHANGED_FILES}" | grep -qE '^(src/|net/|tun/|Cargo\.toml|Cargo\.lock|\.github/workflows/|Dockerfile\.copy)' ; then
            printf 'build_needed=true\n' >> "${GITHUB_OUTPUT}"
          else
            printf 'build_needed=false\n' >> "${GITHUB_OUTPUT}"
          fi

          if printf '%s\n' "${CHANGED_FILES}" | grep -qE '^(src/|net/|tun/|Cargo\.toml|Cargo\.lock|\.github/workflows/|Dockerfile\.copy)'; then
            printf 'docker_needed=true\n' >> "${GITHUB_OUTPUT}"
          else
            printf 'docker_needed=false\n' >> "${GITHUB_OUTPUT}"
          fi

  build_default:
    runs-on: ubuntu-latest
    needs: determine
    if: needs.determine.outputs.build_needed == 'true'
    # Build on Debian trixie so the produced binary links against trixie's glibc.
    container:
      image: rust:1-slim-trixie
    env:
      CARGO_TERM_COLOR: always
      CARGO_HOME: /usr/local/cargo
      RUSTUP_HOME: /usr/local/rustup
      CARGO_TARGET_DIR: target-default
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Install build deps
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            build-essential \
            git \
            pkg-config \
            libssl-dev
          rm -rf /var/lib/apt/lists/*

      - name: Cache cargo (default)
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}/bin/
            ${{ env.CARGO_HOME }}/registry/index/
            ${{ env.CARGO_HOME }}/registry/cache/
            ${{ env.CARGO_HOME }}/git/db/
            ${{ env.CARGO_TARGET_DIR }}
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-default
          restore-keys: |
            ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-

      - name: Install nightly toolchain
        run: |
          rustup toolchain install nightly --profile minimal
          rustup component add rustfmt --toolchain nightly || true

      - name: Build (default)
        run: cargo +nightly build --release --verbose

      - name: Test (default)
        run: cargo +nightly test --release --verbose

      - name: Prepare default artifact
        run: |
          mkdir -p release
          cp ${{ env.CARGO_TARGET_DIR }}/release/lure release/lure
          chmod +x release/lure
          sha256sum release/lure | tee release/lure.sha256

      - name: Upload default artifact
        uses: actions/upload-artifact@v4
        with:
          name: release
          path: |
            release/lure
            release/lure.sha256
          if-no-files-found: error
          overwrite: true

  build_stable:
    runs-on: ubuntu-latest
    needs: determine
    if: needs.determine.outputs.build_needed == 'true' && needs.determine.outputs.stable == 'true'
    container:
      image: rust:1-slim-trixie
    env:
      CARGO_TERM_COLOR: always
      CARGO_HOME: /usr/local/cargo
      RUSTUP_HOME: /usr/local/rustup
      CARGO_TARGET_DIR: target-stable
      RUSTFLAGS: "-Zdylib-lto -C opt-level=3 -C lto=fat -C codegen-units=8 --cfg tokio_unstable -C embed-bitcode=yes -C panic=abort -C incremental=no -C target-cpu=x86-64-v3"
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Install build deps
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            build-essential \
            git \
            pkg-config \
            libssl-dev
          rm -rf /var/lib/apt/lists/*

      - name: Cache cargo ([stable])
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CARGO_HOME }}/bin/
            ${{ env.CARGO_HOME }}/registry/index/
            ${{ env.CARGO_HOME }}/registry/cache/
            ${{ env.CARGO_HOME }}/git/db/
            ${{ env.CARGO_TARGET_DIR }}
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-stable
          restore-keys: |
            ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-

      - name: Install nightly toolchain
        run: |
          rustup toolchain install nightly --profile minimal
          rustup component add rustfmt --toolchain nightly || true

      - name: Build ([stable])
        run: cargo +nightly build --release --verbose

      - name: Prepare [stable] artifact
        run: |
          mkdir -p release-stable
          cp ${{ env.CARGO_TARGET_DIR }}/release/lure release-stable/lure
          chmod +x release-stable/lure
          sha256sum release-stable/lure | tee release-stable/lure.sha256

      - name: Upload [stable] artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-stable
          path: |
            release-stable/lure
            release-stable/lure.sha256
          if-no-files-found: error
          overwrite: true
          
  docker_release:
    runs-on: ubuntu-latest
    needs: [determine, build_default]
    if: github.ref == 'refs/heads/main' && needs.determine.outputs.build_needed == 'true' && needs.determine.outputs.docker_needed == 'true'
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Download release artifact (to repo root)
        uses: actions/download-artifact@v4
        with:
          name: release
          path: .
      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: "v2.1.1"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Build and push (default)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.copy
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  docker_release_stable:
    runs-on: ubuntu-latest
    needs: [determine, build_stable]
    if: github.ref == 'refs/heads/main' && needs.determine.outputs.build_needed == 'true' && needs.determine.outputs.stable == 'true'
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Download [stable] artifact (to repo root)
        uses: actions/download-artifact@v4
        with:
          name: release-stable
          path: .
          
      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: "v2.1.1"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=stable
            type=sha,format=long,prefix=stable-

      - name: Build and push ([stable])
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.copy
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
